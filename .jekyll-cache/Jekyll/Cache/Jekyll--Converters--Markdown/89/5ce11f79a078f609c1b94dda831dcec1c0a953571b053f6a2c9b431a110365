I"$Ü<ul>
  <li>ä»€ä¹ˆæ˜¯Promise</li>
  <li>ä¼ ç»Ÿå¼‚æ­¥è§£å†³æ–¹æ¡ˆ</li>
  <li>è§£æ„Promise</li>
  <li>å®ç°ä¸€ä¸ªPromise</li>
</ul>

<blockquote>
  <p>JavaScriptä½œä¸ºå•çº¿ç¨‹è¯­è¨€ï¼Œå…¶ç‰¹ç‚¹ä¹Ÿæ˜¯å…¶ç¼ºé™·ï¼Œç‰¹ç‚¹æ˜¯ä¸ç”¨å¤„ç†å¤šçº¿ç¨‹å¼•å‘çš„å ç”¨èµ„æºã€å†²çªç­‰ï¼Œç¼ºé™·å°±æ˜¯åŒä¸€æ—¶é—´ï¼Œåªèƒ½åšä¸€ä»¶äº‹æƒ…ã€‚å› æ­¤ä¼šå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œç½‘ç»œä¼ è¾“æ˜¯æœ‰å»¶è¿Ÿçš„ã€‚æ¯”å¦‚Aå‘ä¸€æ¡ä¿¡æ¯ç»™B, Bè¿˜æ²¡è¿”å›ä¿¡æ¯ç»™A, é‚£ä¹ˆAå°±ä¼šä¸€ç›´ç­‰å¾…æ¥å—ä¿¡æ¯ï¼Œä¼šé€ æˆé¡µé¢å¡é¡¿ç­‰é—®é¢˜ã€‚äºæ˜¯å‡ºç°äº†å¼‚æ­¥ã€‚</p>
</blockquote>

<h2 id="ä»€ä¹ˆæ˜¯promise">ä»€ä¹ˆæ˜¯Promise</h2>
<blockquote>
  <p>Promiseæ˜¯ä¸€ä¸ªå®¹å™¨ï¼Œä¿å­˜ç€ä¸€ä¸ªå¼‚æ­¥æ“ä½œçš„ç»“æœã€‚Promiseæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œä»å®ƒå¯ä»¥è·å–å¼‚æ­¥æ“ä½œçš„æ¶ˆæ¯ã€‚Promiseæä¾›äº†ç»Ÿä¸€çš„api, å„ç§å¼‚æ­¥æ“ä½œéƒ½å¯ä»¥ç”¨åŒæ ·çš„æ–¹æ³•è¿›è¡Œå¤„ç†ã€‚</p>
</blockquote>

<h2 id="ä¼ ç»Ÿå¼‚æ­¥è§£å†³æ–¹æ¡ˆ">ä¼ ç»Ÿå¼‚æ­¥è§£å†³æ–¹æ¡ˆ</h2>

<h3 id="ä¸€callbackå›è°ƒ">ä¸€ã€callbackå›è°ƒ</h3>

<p>é€šè¿‡å‚æ•°é—¯å…¥å›è°ƒï¼Œæœªæ¥è°ƒç”¨å›è°ƒæ—¶è®©å‡½æ•°çš„è°ƒç”¨è€…åˆ¤æ–­å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿå›è°ƒå‡½æ•°è¢«è®¤ä¸ºæ˜¯ä¸€ç§é«˜çº§å‡½æ•°ï¼Œä¸€ç§è¢«ä½œä¸ºå‚æ•°ä¼ é€’ç»™å¦ä¸€ä¸ªå‡½æ•°(åœ¨è¿™ç§°ä½œâ€otherFunctionâ€)çš„é«˜çº§å‡½æ•°</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="o">&lt;</span><span class="nx">img</span> <span class="nx">src</span><span class="o">=</span><span class="dl">'</span><span class="s1">../a.jpg</span><span class="dl">'</span><span class="o">&gt;&lt;</span><span class="sr">/img</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="nx">img</span> <span class="nx">src</span><span class="o">=</span><span class="dl">'</span><span class="s1">../b.jpg</span><span class="dl">'</span><span class="o">&gt;&lt;</span><span class="sr">/img</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="nx">img</span> <span class="nx">src</span><span class="o">=</span><span class="dl">'</span><span class="s1">../c.jpg</span><span class="dl">'</span><span class="o">&gt;&lt;</span><span class="sr">/img</span><span class="err">&gt;
</span>
<span class="nx">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">img</span><span class="dl">"</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">title</span><span class="dl">"</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span><span class="nx">attr</span><span class="p">){</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">index</span><span class="p">)</span> <span class="c1">// ä¾æ¬¡è¿”å›0 1 2</span>
<span class="p">});</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<ul>
  <li>ä¼˜ç‚¹ï¼šç®€å•ã€å®¹æ˜“ç†è§£å’Œéƒ¨ç½²</li>
  <li>ç¼ºç‚¹ï¼šä¸åˆ©äºä»£ç çš„é˜…è¯»å’Œç»´æŠ¤ï¼Œç¨‹åºæµç¨‹æ··ä¹±ï¼Œæ¯ä¸ªä»»åŠ¡åªèƒ½æŒ‡å®šä¸€ä¸ªå›è°ƒå‡½æ•°</li>
</ul>

<div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="err">ç›®å½•ç»“æ„ï¼š</span><span class="w">
</span><span class="o">-</span><span class="w"> </span><span class="no">iamswr</span><span class="w">
  </span><span class="o">-</span><span class="w"> </span><span class="nn">A</span><span class="p">.</span><span class="no">txt</span><span class="w">
  </span><span class="o">-</span><span class="w"> </span><span class="nn">B</span><span class="p">.</span><span class="no">txt</span><span class="w">
  </span><span class="o">-</span><span class="w"> </span><span class="nn">C</span><span class="p">.</span><span class="no">txt</span><span class="w">
  
  </span><span class="err">å…¶ä¸­</span><span class="w">
  </span><span class="nn">A</span><span class="p">.</span><span class="no">txt</span><span class="err">æ–‡ä»¶é‡Œçš„å†…å®¹ä¸ºå­—ç¬¦ä¸²</span><span class="nn">B</span><span class="p">.</span><span class="no">txt</span><span class="w">
  </span><span class="nn">B</span><span class="p">.</span><span class="no">txt</span><span class="err">æ–‡ä»¶é‡Œçš„å†…å®¹ä¸ºå­—ç¬¦ä¸²</span><span class="nn">C</span><span class="p">.</span><span class="no">txt</span><span class="w">
  </span><span class="nn">C</span><span class="p">.</span><span class="no">txt</span><span class="err">æ–‡ä»¶é‡Œçš„å†…å®¹ä¸ºå­—ç¬¦ä¸²</span><span class="k">'</span><span class="no">hello</span><span class="w"> </span><span class="no">swr'</span><span class="w">
  
  </span><span class="err">é‚£ä¹ˆå½“æˆ‘ä»¬æƒ³è·å–åˆ°</span><span class="k">'</span><span class="no">hello</span><span class="w"> </span><span class="no">swr'</span><span class="err">ï¼Œä¼šé‡åˆ°ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿè¯·çœ‹ä¸‹é¢çš„ä»£ç </span><span class="w">
  </span><span class="kr">let</span><span class="w"> </span><span class="no">fs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">require</span><span class="o">(</span><span class="k">'</span><span class="no">fs'</span><span class="o">)</span><span class="w">
  </span><span class="nn">fs</span><span class="p">.</span><span class="no">readFile</span><span class="o">(</span><span class="k">'</span><span class="nn">A</span><span class="p">.</span><span class="no">txt'</span><span class="o">,</span><span class="k">'</span><span class="no">utf8'</span><span class="o">,</span><span class="no">function</span><span class="o">(</span><span class="no">err</span><span class="o">,</span><span class="no">data</span><span class="o">){</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="err">æ­¤æ—¶å›è°ƒå‡½æ•°</span><span class="no">data</span><span class="err">å€¼ä¸º</span><span class="k">'</span><span class="nn">B</span><span class="p">.</span><span class="no">txt'</span><span class="w">
      </span><span class="nn">fs</span><span class="p">.</span><span class="no">readFile</span><span class="o">(</span><span class="no">data</span><span class="o">,</span><span class="k">'</span><span class="no">utf8'</span><span class="o">,</span><span class="no">function</span><span class="o">(</span><span class="no">err</span><span class="o">,</span><span class="no">data</span><span class="o">){</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="err">æ­¤æ—¶å›è°ƒå‡½æ•°</span><span class="no">data</span><span class="err">å€¼ä¸º</span><span class="k">'</span><span class="nn">C</span><span class="p">.</span><span class="no">txt'</span><span class="w">
          </span><span class="nn">fs</span><span class="p">.</span><span class="no">readFile</span><span class="o">(</span><span class="no">data</span><span class="o">,</span><span class="k">'</span><span class="no">utf8'</span><span class="o">,</span><span class="no">function</span><span class="o">(</span><span class="no">err</span><span class="o">,</span><span class="no">data</span><span class="o">){</span><span class="w">
            </span><span class="nn">console</span><span class="p">.</span><span class="no">log</span><span class="o">(</span><span class="no">data</span><span class="o">)</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="k">'</span><span class="no">hello</span><span class="w"> </span><span class="no">swr'</span><span class="w">
          </span><span class="o">})</span><span class="w">
      </span><span class="o">})</span><span class="w">
  </span><span class="o">})</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="äºŒäº‹ä»¶å‘å¸ƒè®¢é˜…æ¨¡å¼">äºŒã€äº‹ä»¶å‘å¸ƒï¼è®¢é˜…æ¨¡å¼</h3>

<p>å›è°ƒå‡½æ•°çš„äº‹ä»¶åŒ–ï¼Œä»»åŠ¡çš„æ‰§è¡Œä¸å–å†³äºä»£ç çš„é¡ºåºï¼Œè€Œå–å†³äºæŸä¸ªäº‹ä»¶æ˜¯å¦å‘ç”Ÿ</p>

<ul>
  <li>ä¼˜ç‚¹ï¼šå®¹æ˜“ç†è§£ï¼Œå¯ä»¥ç»‘å®šå¤šä¸ªäº‹ä»¶ï¼Œæ¯ä¸ªäº‹ä»¶å¯ä»¥æŒ‡å®šå¤šä¸ªå›è°ƒå‡½æ•°</li>
  <li>ç¼ºç‚¹ï¼šæ•´ä¸ªç¨‹åºå˜æˆäº†äº‹ä»¶é©±åŠ¨å‹ï¼Œè¿è¡Œæµç¨‹ä¼šå˜å¾—å¾ˆä¸æ¸…æ™°</li>
</ul>

<h3 id="ä¸‰deferredå»¶è¿Ÿå‡½æ•°">ä¸‰ã€Deferredå»¶è¿Ÿå‡½æ•°</h3>

<p>é€šè¿‡deferredå¯¹è±¡ç»™å¼‚æ­¥æ“ä½œè¿›è¡ŒçŠ¶æ€ç»‘å®šï¼Œdeferredå¯¹è±¡æä¾›ç»Ÿä¸€çš„api, å¯¹å„ç§å¼‚æ­¥æ“ä½œçŠ¶æ€è¿›è¡Œæ“ä½œï¼ˆæˆåŠŸã€å¤±è´¥ã€è¿›è¡Œä¸­ï¼‰</p>

<ul>
  <li>ä¼˜ç‚¹ï¼šé¿å…äº†å±‚å±‚åµŒå¥—çš„å›è°ƒå‡½æ•°deferredå¯¹è±¡æä¾›ç»Ÿä¸€çš„æ¥å£ï¼Œæ§åˆ¶å¼‚æ­¥æ“ä½œæ›´å®¹æ˜“ï¼›</li>
  <li>ç¼ºç‚¹ï¼šçŠ¶æ€ä¸å¯é€†ï¼Œä»å¾…å®šçŠ¶æ€åˆ‡æ¢åˆ°ä»»ä½•ä¸€ä¸ªç¡®å®šçŠ¶æ€åï¼Œå†æ¬¡è°ƒç”¨resoleå’Œrejectå¯¹æ„¿çŠ¶æ€å°†ä¸èµ·ä»»ä½•ä½œç”¨ï¼›</li>
</ul>

<h2 id="è§£æ„promise">è§£æ„Promise</h2>

<blockquote>
  <p>æ€è€ƒï¼š ç”¨åŒæ­¥åŒ–çš„æ–¹æ³•æ¥ä¹¦å†™å¼‚æ­¥ä»£ç </p>
</blockquote>

<p>å¼‚æ­¥æ“ä½œçš„çŠ¶æ€ç®¡ç†ï¼šæˆåŠŸ\å¤±è´¥\è¿›è¡Œä¸­ï¼Œæ¯ä¸€ä¸ªçŠ¶æ€ç®¡ç†ä¸€ä¸ªå®¹å™¨ï¼ˆ3ä¸ªï¼‰ï¼Œæ ¹æ®çŠ¶æ€è®¾è®¡ä¸€ä¸ªå®¹å™¨ï¼Œcontainer() add fireï¼ˆä¾æ¬¡æ‰¾åˆ°å¤„ç†å‡½æ•°ï¼‰ï¼Œå³æˆåŠŸä¹‹åçš„äº‹æƒ…ï¼ˆæ‰¾åˆ°å¯¹åº”çš„callbackï¼‰ã€å¤±è´¥ä¹‹åçš„äº‹æƒ…ï¼ˆæ‰¾åˆ°å¯¹åº”çš„callbackï¼‰ã€è¿›è¡Œä¸­ä¹‹åçš„äº‹æƒ…ï¼ˆæ‰¾åˆ°å¯¹åº”çš„callbackï¼‰</p>

<ul>
  <li><code class="highlighter-rouge">æˆåŠŸ</code> resolve()</li>
  <li><code class="highlighter-rouge">å¤±è´¥</code> reject()</li>
  <li><code class="highlighter-rouge">è¿›è¡Œä¸­</code></li>
</ul>

<p>çŸ¥è¯†æ™®åŠï¼š</p>
<blockquote>
  <p>é—­åŒ…æœ€å¤§ç”¨å¤„ï¼š ä¸€ä¸ªå¯ä»¥è¯»å–å‡½æ•°å†…éƒ¨çš„å˜é‡ï¼Œå¦ä¸€ä¸ªå°±æ˜¯è®©è¿™äº›å˜é‡å€¼ä¿æŒåœ¨å†…å­˜ä¸­ï¼›
æ€è€ƒï¼šå°é—­ä½œç”¨åŸŸï¼Œä¿å­˜ä½œç”¨åŸŸï¼Œä½œç”¨åŸŸé“¾æ¡, ä¸æ±¡æŸ“å…¨å±€å˜é‡ã€å—çº§ä½œç”¨åŸŸ</p>
</blockquote>

<p>Promiseçš„ä¸€äº›ç‰¹æ€§</p>
<ul>
  <li>promiseæ˜¯æœ‰å…¼å®¹æ€§é—®é¢˜çš„ï¼Œnodeç¯å¢ƒä¸‹é»˜è®¤æ”¯æŒï¼Œè¿˜å¯ä»¥ä¸‹è½½ç›¸åº”æ’ä»¶æ¥è§£å†³å…¼å®¹æ€§é—®é¢˜</li>
  <li>promiseæ˜¯æœ‰ä¸‰ç§çŠ¶æ€çš„ï¼Œç­‰å¾…æ€pending / æˆåŠŸæ€resolved / å¤±è´¥æ€rejected</li>
  <li>promiseçš„çŠ¶æ€æ˜¯å¯ä»¥è½¬æ¢çš„ï¼Œå¯ä»¥ä»pending -&gt; resolved æˆ– pending -&gt; rejectedï¼Œä½†æ˜¯resolvedä¸èƒ½è½¬æ¢ä¸ºrejected/pendingï¼Œrejectedä¸èƒ½è½¬æ¢ä¸ºresolved/pendingï¼Œç®€è€Œè¨€ä¹‹å³çŠ¶æ€åªä¼šæ›´æ”¹ä¸€æ¬¡</li>
</ul>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="c1">// Promiseæ„é€ å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºexecutor</span>
<span class="kd">let</span> <span class="nx">promise</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span><span class="nx">reject</span><span class="p">){</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">æˆ‘æ˜¯ä¼šè¢«ç«‹å³æ‰§è¡Œçš„å“Ÿ</span><span class="dl">'</span><span class="p">)</span>
<span class="p">})</span>

<span class="c1">// promiseçš„å®ä¾‹éƒ½æœ‰thenæ–¹æ³•</span>
<span class="nx">promise</span><span class="p">.</span><span class="nx">then</span><span class="p">(()</span><span class="o">=&gt;</span><span class="p">{</span> <span class="c1">// æˆåŠŸçš„å›è°ƒ</span>
    
<span class="p">},()</span><span class="o">=&gt;</span><span class="p">{</span> <span class="c1">// å¤±è´¥çš„å›è°ƒ</span>
    
<span class="p">})</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>executoré»˜è®¤åœ¨newçš„æ—¶å€™ä¼šè‡ªåŠ¨æ‰§è¡Œ</li>
  <li>æ¯ä¸ªpromiseçš„å®ä¾‹éƒ½æœ‰thenæ–¹æ³•</li>
  <li>thenæ–¹æ³•ä¸­ï¼Œæœ‰ä¸¤ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯æˆåŠŸçš„å›è°ƒå‡½æ•°å’Œå¤±è´¥çš„å›è°ƒå‡½æ•°</li>
</ul>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="c1">// é»˜è®¤æ—¶ä¸ºpendingæ€ï¼Œæ—¢ä¸ä¼šèµ°æˆåŠŸçš„å›è°ƒä¹Ÿä¸ä¼šèµ°å¤±è´¥çš„å›è°ƒ</span>
<span class="nx">promise</span><span class="p">.</span><span class="nx">then</span><span class="p">(()</span><span class="o">=&gt;</span><span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">success1</span><span class="dl">'</span><span class="p">)</span>
<span class="p">},()</span><span class="o">=&gt;</span><span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">error1</span><span class="dl">'</span><span class="p">)</span>
<span class="p">})</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">2</span><span class="dl">'</span><span class="p">)</span>

<span class="c1">// åœ¨è¿™æ®µä»£ç ä¸­ï¼Œåªä¼šæ‰“å°å‡º'2'ï¼Œå› ä¸ºpromiseä¸€ç›´å¤„äºpendingæ€ï¼Œä¸ä¼šèµ°thenåçš„å›è°ƒå‡½æ•°</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="kd">let</span> <span class="nx">promise</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span><span class="nx">reject</span><span class="p">){</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">1</span><span class="dl">'</span><span class="p">)</span>
    <span class="nx">resolve</span><span class="p">()</span> <span class="c1">// æ›´æ”¹pendingçŠ¶æ€ä¸ºresolved</span>
<span class="p">})</span>

<span class="nx">promise</span><span class="p">.</span><span class="nx">then</span><span class="p">(()</span><span class="o">=&gt;</span><span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">success1</span><span class="dl">'</span><span class="p">)</span>
<span class="p">},()</span><span class="o">=&gt;</span><span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">error1</span><span class="dl">'</span><span class="p">)</span>
<span class="p">})</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">2</span><span class="dl">'</span><span class="p">)</span>

<span class="c1">// æ­¤æ—¶è¾“å‡ºé¡ºåºä¸º'1' -&gt; '2' -&gt; 'success1'</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>thenæ–¹æ³•æ˜¯å¼‚æ­¥çš„ï¼Œå±äºå¾®ä»»åŠ¡ï¼Œä»ä¸Šé¢çš„ä¾‹å­å¯ä»¥çœ‹å‡ºï¼Œå…ˆæ‰§è¡Œå®ŒåŒæ­¥ä»£ç ï¼Œå†æ‰§è¡Œå¼‚æ­¥ä»£ç </p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="kd">let</span> <span class="nx">promise</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span><span class="nx">reject</span><span class="p">){</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">1</span><span class="dl">'</span><span class="p">)</span>
    <span class="nx">setTimeout</span><span class="p">(()</span><span class="o">=&gt;</span><span class="p">{</span> <span class="c1">// å¼‚æ­¥è¡Œä¸º</span>
        <span class="nx">resolve</span><span class="p">()</span> <span class="c1">// æ›´æ”¹çŠ¶æ€ä¸ºæˆåŠŸ</span>
    <span class="p">},</span><span class="mi">1000</span><span class="p">)</span>
<span class="p">})</span>

<span class="nx">promise</span><span class="p">.</span><span class="nx">then</span><span class="p">(()</span><span class="o">=&gt;</span><span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">success1</span><span class="dl">"</span><span class="p">)</span>
<span class="p">})</span>

<span class="nx">promise</span><span class="p">.</span><span class="nx">then</span><span class="p">(()</span><span class="o">=&gt;</span><span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">success2</span><span class="dl">'</span><span class="p">)</span>
<span class="p">})</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">2</span><span class="dl">"</span><span class="p">)</span>

<span class="c1">// æ­¤æ—¶è¾“å‡ºé¡ºåºä¸º'1' -&gt; '2' -&gt; 'success1' -&gt; 'success2'</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>åŒä¸€ä¸ªpromiseçš„å®ä¾‹å¯ä»¥thenå¤šæ¬¡,æˆåŠŸæ—¶ä¼šè°ƒç”¨æ‰€æœ‰çš„æˆåŠŸæ–¹æ³•ï¼Œå¤±è´¥æ—¶ä¼šè°ƒç”¨æ‰€æœ‰çš„å¤±è´¥æ–¹æ³•</li>
  <li>new Promiseä¸­å¯ä»¥æ”¯æŒå¼‚æ­¥è¡Œä¸º</li>
  <li>å¦‚æœå‘ç°é”™è¯¯ï¼Œå°±ä¼šè¿›å…¥å¤±è´¥æ€</li>
</ul>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="kd">let</span> <span class="nx">promise</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span><span class="nx">reject</span><span class="p">){</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">'</span><span class="s1">å‡ºé”™äº†</span><span class="dl">'</span><span class="p">)</span> <span class="c1">// æŠ›å‡ºé”™è¯¯</span>
<span class="p">})</span>

<span class="nx">promise</span><span class="p">.</span><span class="nx">then</span><span class="p">(()</span><span class="o">=&gt;</span><span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">success1</span><span class="dl">'</span><span class="p">)</span>
<span class="p">},()</span><span class="o">=&gt;</span><span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">error1</span><span class="dl">'</span><span class="p">)</span>
<span class="p">})</span>

<span class="c1">// æ­¤æ—¶è¾“å‡ºä¸º 'error1'</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="å®ç°ä¸€ä¸ªpromise">å®ç°ä¸€ä¸ªPromise</h2>

<p>ä¸‹é¢ä»£ç éƒ¨åˆ†å’Œæºç å®ç°éƒ¨åˆ†è¦ç»“åˆæ¥çœ‹</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="c1">// ----- ä»£ç éƒ¨åˆ†</span>
<span class="c1">// 1.executoré»˜è®¤åœ¨newçš„æ—¶å€™ä¼šè‡ªåŠ¨æ‰§è¡Œ</span>
<span class="c1">// æˆåŠŸå’Œå¤±è´¥çš„è§†ä¹å¯ä»¥ä¼ é€’å‚æ•°</span>
<span class="kd">let</span> <span class="nx">promise</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span><span class="nx">reject</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span> <span class="c1">// 6.resolveã€rejectå‡½æ•°å¯¹åº”æºç å®ç°éƒ¨åˆ†çš„resolveã€rejectå‡½æ•°</span>
    <span class="nx">resolve</span><span class="p">(</span><span class="dl">'</span><span class="s1">hello swr</span><span class="dl">'</span><span class="p">)</span> <span class="c1">// 11.æ‰§è¡Œresolve</span>
<span class="p">})</span>

<span class="c1">// 7.Promiseçš„å®ä¾‹éƒ½æœ‰thenæ–¹æ³•</span>
<span class="nx">promise</span><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">data</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span> <span class="c1">// 8.æˆåŠŸçš„å›è°ƒå‡½æ•°</span>
    
<span class="p">},(</span><span class="nx">err</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span> <span class="c1">// 9.å¤±è´¥çš„å›è°ƒå‡½æ•°</span>
    
<span class="p">})</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre></td><td class="rouge-code"><pre><span class="c1">// ----- æºç å®ç°éƒ¨åˆ†</span>
<span class="c1">// 2.å£°æ˜ä¸€ä¸ªPromiseæ„é€ å‡½æ•°</span>
<span class="kd">function</span> <span class="nb">Promise</span><span class="p">(</span><span class="nx">executor</span><span class="p">){</span>
    <span class="kd">let</span> <span class="nb">self</span> <span class="o">=</span> <span class="k">this</span>
    <span class="nb">self</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="kc">undefined</span>
    <span class="nb">self</span><span class="p">.</span><span class="nx">reason</span> <span class="o">=</span> <span class="kc">undefined</span> <span class="c1">// 12.å› ä¸ºvalueå’Œreasonå€¼éœ€è¦åœ¨Promiseå®ä¾‹æ–¹æ³•thenä¸­ä½¿ç”¨ï¼Œæ‰€ä»¥æŠŠè¿™ä¸¤ä¸ªå€¼ï¼Œèµ‹ç»™newå‡ºæ¥çš„å®ä¾‹</span>
    <span class="kd">function</span> <span class="nx">resolve</span><span class="p">(</span><span class="nx">value</span><span class="p">){</span> <span class="c1">// 3.å£°æ˜ä¸€ä¸ªresolveå‡½æ•°</span>
      <span class="k">if</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">pending</span><span class="dl">'</span><span class="p">){</span> <span class="c1">// 2.æ­¤æ—¶æ–°å¢ä¸€ä¸ªçŠ¶æ€åˆ¤æ–­ï¼Œå½“çŠ¶æ€ä¸ºpendingçš„æ—¶å€™æ‰èƒ½æ‰§è¡Œ</span>
        <span class="nb">self</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span> <span class="c1">// 13.å½“è°ƒç”¨äº†resolveå¹¶ä¸”ä¼ å‚æ•°æ—¶ï¼Œåˆ™æŠŠè¿™valueå€¼èµ‹äºˆself.value</span>
        <span class="nb">self</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">resolved</span><span class="dl">'</span> <span class="c1">// 2.å½“è°ƒç”¨äº†resolveæ—¶ï¼Œæ›´æ”¹çŠ¶æ€ä¸ºresolved</span>
      <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">function</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">reason</span><span class="p">){</span> <span class="c1">// 4.å£°æ˜ä¸€ä¸ªrejectå‡½æ•°</span>
     <span class="k">if</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">pending</span><span class="dl">'</span><span class="p">){</span> <span class="c1">// 2.æ­¤æ—¶æ–°å¢ä¸€ä¸ªçŠ¶æ€åˆ¤æ–­ï¼Œå½“çŠ¶æ€ä¸ºpendingçš„æ—¶å€™æ‰èƒ½æ‰§è¡Œ</span>
        <span class="nb">self</span><span class="p">.</span><span class="nx">reason</span> <span class="o">=</span> <span class="nx">reason</span> <span class="c1">// 13.å½“è°ƒç”¨äº†rejectå¹¶ä¸”ä¼ å‚æ•°æ—¶ï¼Œåˆ™æŠŠè¿™reasonå€¼èµ‹äºˆself.reason</span>
        <span class="nb">self</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">rejected</span><span class="dl">'</span> <span class="c1">// 2.å½“è°ƒç”¨äº†rejectæ—¶ï¼Œæ›´æ”¹çŠ¶æ€ä¸ºrejected</span>
     <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// 5.å½“æˆ‘ä»¬åœ¨æ‰§è¡Œexecutoræ—¶ï¼Œå†…éƒ¨æŠ›å‡ºé”™è¯¯çš„æ—¶å€™ï¼Œå¯ä»¥åˆ©ç”¨try catchæ¥å¤„ç†è¿™ä¸ªé—®é¢˜</span>
    <span class="k">try</span><span class="p">{</span>
        <span class="nx">executor</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span><span class="nx">reject</span><span class="p">)</span>
    <span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span>
        <span class="nx">reject</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="p">}</span>

<span class="c1">// å› ä¸ºPromiseçš„å®ä¾‹éƒ½æœ‰thenæ–¹æ³•ï¼Œé‚£ä¹ˆæ„å‘³ç€thenæ–¹æ³•æ˜¯åœ¨Promiseçš„åŸå‹å¯¹è±¡ä¸­çš„æ–¹æ³•</span>
<span class="c1">// 10.å¯¹åº”ä¸Šé¢æˆåŠŸçš„å›è°ƒå‡½æ•°onFulfilledä»¥åŠå¤±è´¥çš„å›è°ƒå‡½æ•°onRejected</span>
<span class="nb">Promise</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">then</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">onFulfilled</span><span class="p">,</span><span class="nx">onRejected</span><span class="p">){</span>
    <span class="kd">let</span> <span class="nb">self</span> <span class="o">=</span> <span class="k">this</span>
    <span class="c1">// 3.å½“æˆ‘ä»¬åœ¨thenä¸­ï¼Œæ‰§è¡Œäº†æˆåŠŸæˆ–è€…å¤±è´¥çš„å›è°ƒå‡½æ•°æ—¶ï¼Œé¦–å…ˆè¦åˆ¤æ–­ç›®å‰å¤„äºä»€ä¹ˆçŠ¶æ€</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">resolved</span><span class="dl">'</span><span class="p">){</span>
        <span class="nx">onFulfilled</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span> <span class="c1">// 4.å½“è°ƒç”¨äº†resolveå‡½æ•°åï¼Œä¼šæ‰§è¡ŒæˆåŠŸçš„å›è°ƒå‡½æ•°ï¼Œå¹¶ä¸”æŠŠresolveä¸­ä¼ é€’çš„å€¼ï¼Œä¼ é€’ç»™æˆåŠŸçš„å›è°ƒå‡½æ•°</span>
    <span class="p">}</span>
    
    <span class="k">if</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">rejected</span><span class="dl">'</span><span class="p">){</span>
        <span class="nx">onRejected</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nx">reason</span><span class="p">)</span> <span class="c1">// 4.å½“è°ƒç”¨äº†rejectå‡½æ•°åï¼Œä¼šæ‰§è¡ŒæˆåŠŸçš„å›è°ƒå‡½æ•°ï¼Œå¹¶ä¸”æŠŠrejectä¸­ä¼ é€’çš„å€¼ï¼Œä¼ é€’ç»™å¤±è´¥çš„å›è°ƒå‡½æ•°</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nb">Promise</span> <span class="c1">// æŠŠPromiseæš´éœ²å‡ºå»</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<blockquote>
  <p>æ€è€ƒï¼šå¦‚æœæ­¤æ—¶resolveæˆ–è€…rejectæ˜¯å¤„äºsetTimeout(()=&gt;{resolve()},3000)ä¸­ï¼Œå³å¤„äºå¼‚æ­¥ä¸­ï¼Œå½“æˆ‘ä»¬newä¸€ä¸ªPromiseæ—¶ï¼Œä¸ä¼šé©¬ä¸Šæ‰§è¡Œå¼‚æ­¥ä»£ç ï¼Œè€Œæ˜¯ç›´æ¥æ‰§è¡Œäº†promise.thenè¿™ä¸ªå‡½æ•°ï¼Œè€Œæ­¤æ—¶å› ä¸ºself.statusçš„çŠ¶æ€ä¾ç„¶æ˜¯å¤„äºpendingï¼Œæ‰€ä»¥ä¸ä¼šæ‰§è¡Œresolveæˆ–è€…rejectï¼Œå½“åŒæ­¥ä»£ç æ‰§è¡Œå®Œæ¯•åï¼Œæ‰§è¡Œå¼‚æ­¥ä»£ç æ—¶ï¼Œæ›´æ”¹äº†çŠ¶æ€ä¸ºresolvedæˆ–è€…rejectedæ—¶ï¼Œæ­¤æ—¶thenæ–¹æ³•å·²ç»æ‰§è¡Œå®Œæ¯•äº†ï¼Œä¸ä¼šå†æ¬¡æ‰§è¡Œthençš„æ–¹æ³•ï¼Œé‚£ä¹ˆæ­¤æ—¶æˆ‘ä»¬è¯¥å¦‚ä½•å¤„ç†ï¼Ÿ</p>
</blockquote>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
</pre></td><td class="rouge-code"><pre>
<span class="c1">// ----- æºç å®ç°éƒ¨åˆ†</span>
<span class="kd">function</span> <span class="nb">Promise</span><span class="p">(</span><span class="nx">executor</span><span class="p">){</span>
    <span class="kd">let</span> <span class="nb">self</span> <span class="o">=</span> <span class="k">this</span>
    <span class="nb">self</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="kc">undefined</span>
    <span class="nb">self</span><span class="p">.</span><span class="nx">reason</span> <span class="o">=</span> <span class="kc">undefined</span> 
    <span class="nb">self</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">pending</span><span class="dl">'</span>
    <span class="nb">self</span><span class="p">.</span><span class="nx">onResolvedCallbacks</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1">// 2.å¯èƒ½new Promiseä¸­ä¼šæœ‰å¼‚æ­¥çš„æ“ä½œï¼Œæ­¤æ—¶æˆ‘ä»¬æŠŠå¼‚æ­¥æ“ä½œæ—¶ï¼Œæ‰§è¡Œçš„thenå‡½æ•°çš„æˆåŠŸå›è°ƒï¼Œç»Ÿä¸€ä¿å­˜åœ¨è¯¥æ•°ç»„ä¸­</span>
    <span class="nb">self</span><span class="p">.</span><span class="nx">onRejectedCallbacks</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1">// 2.å¯èƒ½new Promiseä¸­ä¼šæœ‰å¼‚æ­¥çš„æ“ä½œï¼Œæ­¤æ—¶æˆ‘ä»¬æŠŠå¼‚æ­¥æ“ä½œæ—¶ï¼Œæ‰§è¡Œçš„thenå‡½æ•°çš„å¤±è´¥å›è°ƒï¼Œç»Ÿä¸€ä¿å­˜åœ¨è¯¥æ•°ç»„ä¸­</span>
    <span class="kd">function</span> <span class="nx">resolve</span><span class="p">(</span><span class="nx">value</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">pending</span><span class="dl">'</span><span class="p">){</span> 
            <span class="nb">self</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span> 
            <span class="nb">self</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">resolved</span><span class="dl">'</span>
            <span class="c1">// 4.å½“è°ƒç”¨resolveæ—¶ï¼ŒæŠŠè¯¥æ•°ç»„ä¸­å­˜æ”¾çš„æˆåŠŸå›è°ƒéƒ½æ‰§è¡Œä¸€éï¼Œå¦‚æœæ˜¯å¼‚æ­¥ï¼Œåˆ™ä¼šæŠŠæˆåŠŸçš„å›è°ƒéƒ½å­˜åˆ°è¯¥æ•°ç»„é‡Œäº†ï¼Œå¦‚æœæ˜¯å¼‚æ­¥ï¼Œåˆ™æ²¡å­˜åˆ°ã€‚</span>
            <span class="nb">self</span><span class="p">.</span><span class="nx">onResolvedCallbacks</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">fn</span><span class="o">=&gt;</span><span class="nx">fn</span><span class="p">())</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">function</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">reason</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">pending</span><span class="dl">'</span><span class="p">){</span> 
            <span class="nb">self</span><span class="p">.</span><span class="nx">reason</span> <span class="o">=</span> <span class="nx">reason</span> 
            <span class="nb">self</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">rejected</span><span class="dl">'</span>
            <span class="c1">// 4.å½“è°ƒç”¨rejectæ—¶ï¼ŒæŠŠè¯¥æ•°ç»„ä¸­å­˜æ”¾çš„å¤±è´¥å›è°ƒéƒ½æ‰§è¡Œä¸€éï¼Œå¦‚æœæ˜¯å¼‚æ­¥ï¼Œåˆ™ä¼šæŠŠæˆåŠŸçš„å›è°ƒéƒ½å­˜åˆ°è¯¥æ•°ç»„é‡Œäº†ï¼Œå¦‚æœæ˜¯å¼‚æ­¥ï¼Œåˆ™æ²¡å­˜åˆ°ã€‚</span>
            <span class="nb">self</span><span class="p">.</span><span class="nx">onRejectedCallbacks</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">fn</span><span class="o">=&gt;</span><span class="nx">fn</span><span class="p">())</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="k">try</span><span class="p">{</span>
        <span class="nx">executor</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span><span class="nx">reject</span><span class="p">)</span>
    <span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span>
        <span class="nx">reject</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nb">Promise</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">then</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">onFulfilled</span><span class="p">,</span><span class="nx">onRejected</span><span class="p">){</span>
    <span class="kd">let</span> <span class="nb">self</span> <span class="o">=</span> <span class="k">this</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">resolved</span><span class="dl">'</span><span class="p">){</span>
        <span class="nx">onFulfilled</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span> 
    <span class="p">}</span>
    
    <span class="k">if</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">rejected</span><span class="dl">'</span><span class="p">){</span>
        <span class="nx">onRejected</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nx">reason</span><span class="p">)</span> 
    <span class="p">}</span>
    
    <span class="c1">// 3.å½“new Promiseä¸­æœ‰resolveã€rejectå¤„äºå¼‚æ­¥ä¸­ï¼Œæ‰§è¡Œthençš„æ—¶å€™ï¼ŒçŠ¶æ€ä¸ºpendingï¼Œ</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">pending</span><span class="dl">'</span><span class="p">){</span>
        <span class="nb">self</span><span class="p">.</span><span class="nx">onResolvedCallbacks</span><span class="p">.</span><span class="nx">push</span><span class="p">(()</span><span class="o">=&gt;</span><span class="p">{</span>
            <span class="nx">onFulfilled</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span>
        <span class="p">})</span> <span class="c1">// 3. æŠŠæˆåŠŸçš„å›è°ƒå‡½æ•°ï¼Œå­˜åˆ°è¯¥æ•°ç»„ä¸­ï¼Œè¿™æ ·å†™çš„å¥½å¤„ï¼Œå°±æ˜¯æŠŠå‚æ•°ä¼ è¿›å»ï¼Œä¸éœ€è¦å°†æ¥éå†onResolvedCallbacksæ—¶ï¼Œå†ä¼ å‚</span>
        <span class="nb">self</span><span class="p">.</span><span class="nx">onRejectedCallbacks</span><span class="p">.</span><span class="nx">push</span><span class="p">(()</span><span class="o">=&gt;</span><span class="p">{</span>
            <span class="nx">onRejected</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nx">reason</span><span class="p">)</span>
        <span class="p">})</span> <span class="c1">// 3. æŠŠå¤±è´¥çš„å›è°ƒå‡½æ•°ï¼Œå­˜åˆ°è¯¥æ•°ç»„ä¸­ï¼Œè¿™æ ·å†™çš„å¥½å¤„ï¼Œå°±æ˜¯æŠŠå‚æ•°ä¼ è¿›å»ï¼Œä¸éœ€è¦å°†æ¥éå†onRejectedCallbacksæ—¶ï¼Œå†ä¼ å‚</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nb">Promise</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<blockquote>
  <p>æ€è€ƒï¼šåŒä¸€ä¸ªpromiseçš„å®ä¾‹å¯ä»¥thenå¤šæ¬¡,æˆåŠŸæ—¶ä¼šè°ƒç”¨æ‰€æœ‰çš„æˆåŠŸæ–¹æ³•ï¼Œå¤±è´¥æ—¶ä¼šè°ƒç”¨æ‰€æœ‰çš„å¤±è´¥æ–¹æ³•ï¼Œé‚£è¿™ä¸ªåˆè¯¥å¦‚ä½•å¤„ç†å‘¢ï¼Ÿ</p>
</blockquote>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
</pre></td><td class="rouge-code"><pre><span class="kd">function</span> <span class="nb">Promise</span><span class="p">(</span><span class="nx">executor</span><span class="p">){</span>
  <span class="kd">let</span> <span class="nb">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="nb">self</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span> <span class="c1">// æˆåŠŸçš„å€¼</span>
  <span class="nb">self</span><span class="p">.</span><span class="nx">reason</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span> <span class="c1">// å¤±è´¥çš„å€¼</span>
  <span class="nb">self</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">pending</span><span class="dl">"</span><span class="p">;</span> <span class="c1">// ç›®å‰promiseçš„çŠ¶æ€ä¸ºpendingï¼Œè¿˜æœ‰resolvedã€rejected</span>
  <span class="nb">self</span><span class="p">.</span><span class="nx">onResolvedCallbacks</span> <span class="o">=</span> <span class="p">[];</span> <span class="c1">// å¯èƒ½new promiseçš„æ—¶å€™å­˜åœ¨å¼‚æ­¥æ“ä½œï¼ŒæŠŠæˆåŠŸå’Œå¤±è´¥å›è°ƒä¿å­˜èµ·æ¥</span>
  <span class="nb">self</span><span class="p">.</span><span class="nx">onRejectedCallbacks</span> <span class="o">=</span> <span class="p">[];</span>

  <span class="c1">// æŠŠçŠ¶æ€æ›´æ”¹ä¸ºæˆåŠŸ</span>
  <span class="kd">function</span> <span class="nx">resolve</span><span class="p">(</span><span class="nx">value</span><span class="p">){</span> 
    <span class="c1">// åªæœ‰pendingçŠ¶æ€æ‰èƒ½è½¬ä¸ºæˆåŠŸçŠ¶æ€</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">pending</span><span class="dl">'</span><span class="p">){</span>
      <span class="nb">self</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
      <span class="nb">self</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">resolved</span><span class="dl">"</span><span class="p">;</span>
      <span class="nb">self</span><span class="p">.</span><span class="nx">onResolvedCallbacks</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">fn</span> <span class="o">=&gt;</span> <span class="nx">fn</span><span class="p">());</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">reason</span><span class="p">){</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">pending</span><span class="dl">'</span><span class="p">){</span>
      <span class="nb">self</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">rejected</span><span class="dl">"</span>
      <span class="nb">self</span><span class="p">.</span><span class="nx">reason</span> <span class="o">=</span> <span class="nx">reason</span><span class="p">;</span>
      <span class="nb">self</span><span class="p">.</span><span class="nx">onRejectedCallbacks</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">fn</span> <span class="o">=&gt;</span> <span class="nx">fn</span><span class="p">());</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">try</span> <span class="p">{</span>
    <span class="nx">executor</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">reject</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**
 * æ‰€æœ‰çš„promiseéƒ½éµå¾ªè¿™ä¸ªè§„èŒƒï¼Œæ‰€æœ‰çš„promiseå¯ä»¥é€šç”¨
 * @param {*} promise2  thençš„è¿”å›å€¼ï¼Œè¿”å›æ–°çš„promise
 * @param {*} x thenä¸­æˆåŠŸå‡½æ•°æˆ–å¤±è´¥å‡½æ•°çš„è¿”å›å€¼
 * @param {*} resolve  promise2çš„resolve
 * @param {*} reject promise2çš„reject
 */</span>
<span class="kd">function</span> <span class="nx">resolvePromise</span><span class="p">(</span><span class="nx">promise2</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">){</span>
  <span class="c1">// promise2å’Œxæ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œreject</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">promise2</span> <span class="o">===</span> <span class="nx">x</span><span class="p">){</span>
    <span class="k">return</span> <span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="dl">'</span><span class="s1">Chaining cycle detected for promise</span><span class="dl">'</span><span class="p">));</span>
  <span class="p">}</span>
  <span class="kd">let</span> <span class="nx">called</span><span class="p">;</span>
  <span class="c1">// thençš„è¿”å›å€¼æ˜¯promiseï¼Œå½“xä¸ºå¯¹è±¡æˆ–è€…å‡½æ•°ï¼Œæ‰å¯èƒ½æ˜¯promise</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">x</span><span class="o">!==</span><span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">x</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">object</span><span class="dl">'</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">x</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">function</span><span class="dl">'</span><span class="p">)){</span>

    <span class="k">try</span><span class="p">{</span>
      <span class="kd">let</span> <span class="nx">then</span> <span class="o">=</span> <span class="nx">x</span><span class="p">.</span><span class="nx">then</span><span class="p">;</span>
      <span class="c1">// xå¯ä»¥è¿˜æ˜¯ä¸ªpromiseï¼Œæ’é™¤{then:{}}</span>
      <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">then</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">function</span><span class="dl">'</span><span class="p">){</span>
        <span class="nx">then</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="p">(</span><span class="nx">y</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
          <span class="c1">// yæ˜¯è¿”å›promiseåæˆåŠŸç»“æœ</span>
          <span class="c1">// å¦‚æœåˆ«äººçš„promiseå¯èƒ½æ—¢ä¼šè°ƒresolveä¹Ÿä¼šè°ƒrejectï¼Œé‚£ä¹ˆå°±ä¼šå‡ºé—®é¢˜äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¥ä¸‹æ¥è¦é™åˆ¶</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">called</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
          <span class="nx">called</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
          <span class="c1">// ä»£ç ä¼šä¸€ç›´é€’å½’ï¼Œå–åˆ°æœ€åä¸€å±‚promis</span>
          <span class="nx">resolvePromise</span><span class="p">(</span><span class="nx">promise2</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">);</span>
       
        <span class="p">},(</span><span class="nx">err</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
          <span class="c1">// è¿”å›promiseå¤±è´¥ç»“æœ</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">called</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
          <span class="nx">called</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
          <span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
        <span class="p">});</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="nx">resolve</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="c1">// å¦‚æœthenä¸æ˜¯å‡½æ•°çš„è¯ï¼Œé‚£ä¹ˆåˆ™æ˜¯æ™®é€šå¯¹è±¡ï¼Œç›´æ¥èµ°resolveæˆåŠŸ</span>
      <span class="p">}</span>
    <span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">called</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
      <span class="nx">called</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="nx">reject</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span><span class="k">else</span><span class="p">{</span>
    <span class="c1">// xä¸ºä¸€ä¸ªå¸¸é‡ï¼Œåˆ™æ˜¯èµ°resolveæˆåŠŸ</span>
    <span class="nx">resolve</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nb">Promise</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">then</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">onFullfilled</span><span class="p">,</span> <span class="nx">onRejected</span><span class="p">){</span>
  <span class="kd">let</span> <span class="nb">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="c1">// é‚£ä¹ˆæˆ‘ä»¬newä¸€ä¸ªæ–°çš„promiseï¼Œå¹¶ä¸”æŠŠä»¥ä¸‹ä»£ç æ”¾åˆ°promiseä¸­</span>
  <span class="kd">let</span> <span class="nx">promise2</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">resolved</span><span class="dl">'</span><span class="p">){</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="c1">// è¿™é‡Œçš„xï¼Œ ä¸Šä¸€å±‚thenæ‰§è¡Œè¿”å›çš„ç»“æœ</span>
        <span class="kd">let</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">onFullfilled</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
        <span class="c1">// æä¾›ä¸€ä¸ªresolvePromiseå‡½æ•°å¤„ç†promise2ï¼Œ thenä¸ç®¡æ˜¯æˆåŠŸå›è°ƒã€å¤±è´¥å›è°ƒï¼Œè¿”å›å€¼å¯èƒ½ä¸ºpromiseï¼æ™®é€šå€¼ï¼æŠ›å‡ºé”™è¯¯å€¼</span>
        <span class="nx">resolvePromise</span><span class="p">(</span><span class="nx">promise2</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
        <span class="nx">reject</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">rejected</span><span class="dl">'</span><span class="p">){</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nx">x</span> <span class="o">=</span>  <span class="nx">onRejected</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nx">reason</span><span class="p">);</span>
        <span class="nx">resolvePromise</span><span class="p">(</span><span class="nx">promise2</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
        <span class="nx">reject</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">pending</span><span class="dl">'</span><span class="p">){</span>
      <span class="c1">// æŠŠæˆåŠŸå›è°ƒå‡½æ•°ï¼Œå­˜åˆ°æ”¹æ•°ç»„ä¸­ï¼ŒæŠŠå‚æ•°ä¼ è¿›å»ï¼Œä¸éœ€è¦å°†æ¥éå†onResolvedCallbacksæ—¶ï¼Œå†ä¼ å‚</span>
      <span class="nb">self</span><span class="p">.</span><span class="nx">onResolvedCallbacks</span><span class="p">.</span><span class="nx">push</span><span class="p">(()</span><span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="kd">let</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">onFullfilled</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
            <span class="nx">resolvePromise</span><span class="p">(</span><span class="nx">promise2</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
          <span class="nx">reject</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">});</span>
      <span class="nb">self</span><span class="p">.</span><span class="nx">onRejectedCallbacks</span><span class="p">.</span><span class="nx">push</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
          <span class="kd">let</span> <span class="nx">x</span> <span class="o">=</span>  <span class="nx">onRejected</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nx">reason</span><span class="p">);</span>
          <span class="nx">resolvePromise</span><span class="p">(</span><span class="nx">promise2</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
          <span class="nx">reject</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">});</span>
  <span class="k">return</span> <span class="nx">promise2</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// æ˜¯å¦ä¸ºæ¨¡å—å¼•å…¥ï¼Œå¥å£®æ€§åˆ¤æ–­</span>
<span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">module</span> <span class="o">!==</span> <span class="dl">'</span><span class="s1">undefined</span><span class="dl">'</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">!==</span> <span class="dl">'</span><span class="s1">undefined</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nb">Promise</span><span class="p">;</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">define</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">function</span><span class="dl">'</span> <span class="o">&amp;&amp;</span> <span class="nx">define</span><span class="p">.</span><span class="nx">amd</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">define</span><span class="p">([],</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nb">Promise</span><span class="p">;</span>
    <span class="p">});</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nb">window</span><span class="p">.</span><span class="nb">Promise</span> <span class="o">=</span> <span class="nb">Promise</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

</pre></td></tr></tbody></table></code></pre></div></div>
:ET